var errorLoadingMapsAPI,initMap;!function(){"use strict";function e(){var e,a=new google.maps.LatLngBounds;u.places().forEach(function(n){e=n().marker,n().visible?(e.getVisible()||(e.setAnimation(google.maps.Animation.DROP),e.setVisible(!0)),a.extend(e.position)):e.setVisible(!1)}),u.visiblePlaces().length>0&&r.fitBounds(a)}function a(e,a){var n=document.getElementById("iw-template").innerHTML;a.marker!=e.marker&&(a.marker=e.marker,a.setContent(n),a.open(r,e.marker),a.addListener("closeclick",function(){a.marker=null}),ko.applyBindings(u,document.getElementById("iw-content")))}function n(){var e=r.getCenter();google.maps.event.trigger(r,"resize"),r.setCenter(e)}function t(){return Math.floor(1e12*Math.random()).toString()}function o(e){e.yelpStatus("loading");var a="https://api.yelp.com/v2/business/"+e.yelpId,n={oauth_consumer_key:"xx0hsyOwIU0y1Vq3pRoKzA",oauth_token:"llUXjhOIRNdQkYLcYvK851Cod3fxt-te",oauth_nonce:t(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb"},o=oauthSignature.generate("GET",a,n,"jafcYJDzO3Vs8KSZqgcKM2MJAlo","GfCUDzASwfhKPW1UAXXCPZpm3e4");n.oauth_signature=o;var r={url:a,data:n,cache:!0,dataType:"jsonp",success:function(a){e.yelpData(a),e.yelpStatus("ready")},error:function(){e.yelpStatus("error")}};$.ajax(r)}var r,l,i=[{yelpId:"koy-shunka-barcelona",name:"Koy Shunka",location:{lat:41.3857825,lng:2.1753695},address:"Carrer d'en Copons, 7",neighborhood:"Barri Gòtic",telephone:"+34 934 127 939",website:"http://www.koyshunka.com/"},{yelpId:"kuo-barcelona",name:"Kuo",location:{lat:41.3965255,lng:2.1442039},address:"Carrer Madrazo, 135",neighborhood:"Sant Gervasi",telephone:"+34 932 007 783",website:"http://www.gruponomo.com/restaurantes/kuo/"},{yelpId:"yashima-barcelona",name:"Yashima",location:{lat:41.3909975,lng:2.1433599},address:"Av. de Josep Tarradellas, 145",neighborhood:"Les Corts",telephone:"+34 934 190 697",website:null},{yelpId:"tempura-ya-barcelona",name:"Tempura Ya",location:{lat:41.3910347,lng:2.1534075},address:"Carrer de Muntaner, 153",neighborhood:"Esquerra de l'Eixample",telephone:"+34 934 193 182",website:null},{yelpId:"shibui-barcelona",name:"Shibui",location:{lat:41.3912991,lng:2.1466128},address:"Carrer del Comte d'Urgell, 272",neighborhood:"Esquerra de l'Eixample",telephone:"+34 933 219 004",website:"http://www.shibuirestaurantes.com/"},{yelpId:"shunka-barcelona",name:"Shunka",location:{lat:41.3851057,lng:2.1751387},address:"Carrer Sagristans, 5",neighborhood:"Barri Gòtic",telephone:"+34 934 124 991",website:null},{yelpId:"ikibana-paralelo-barcelona-5",name:"Ikibana Paralelo",location:{lat:41.375197,lng:2.158238},address:"Av. del Paral·lel, 148",neighborhood:"Sant Antoni",telephone:"+34 934 244 648",website:"http://www.ikibana.com/"},{yelpId:"kibuka-barcelona",name:"Kibuka",location:{lat:41.39971,lng:2.157236},address:"Carrer de Goya, 9",neighborhood:"Vila de Gràcia",telephone:"+34 932 378 994",website:"http://www.kibuka.com/"},{yelpId:"nomo-barcelona",name:"Nomo",location:{lat:41.3981505,lng:2.1571036},address:"Carrer Gran de Gràcia, 13",neighborhood:"Vila de Gràcia",telephone:"+34 934 159 622",website:"http://restaurantenomo.com"},{yelpId:"yamadori-barcelona",name:"Yamadori",location:{lat:41.3889126,lng:2.1588497},address:"Carrer d'Aribau, 68",neighborhood:"Esquerra de l'Eixample",telephone:"+34 934 539 264",website:"http://www.yamashitagroup.com/yamadori/entrantes.htm"}],s=function(e,a){a="undefined"==typeof a||a,this.yelpId=e.yelpId,this.name=e.name,this.location=e.location,this.address=e.address,this.neighborhood=e.neighborhood,this.telephone=e.telephone,this.website=e.website,this.visible=a,this.yelpStatus=ko.observable(),this.yelpData=ko.observable()},c=function(){var t=this;this.places=ko.observableArray(i.map(function(e){return ko.observable(new s(e))})),this.currentPlace=ko.observable(),this.currentFilter=ko.observable(),this.visiblePlaces=ko.computed(function(){return t.places().filter(function(e){return e().visible})}),this.getYelpReviewCount=ko.computed(function(e){return t.currentPlace()&&t.currentPlace().yelpData()?t.currentPlace().yelpData().review_count:null}),this.getYelpRatingImg=ko.computed(function(e){return t.currentPlace()&&t.currentPlace().yelpData()?t.currentPlace().yelpData().rating_img_url:null}),this.getYelpRatingImgSrcSet=ko.computed(function(e){return t.currentPlace()&&t.currentPlace().yelpData()?t.currentPlace().yelpData().rating_img_url_large+" 2x, "+t.currentPlace().yelpData().rating_img_url+" 1x":null}),this.getYelpURL=ko.computed(function(e){return t.currentPlace()&&t.currentPlace().yelpData()?t.currentPlace().yelpData().url:null}),this.visiblePanel=ko.observable(!1),this.pinnedPanel=ko.observable(!1),this.showPanel=function(){t.visiblePanel(!0)},this.togglePinPanel=function(){t.pinnedPanel(!t.pinnedPanel()),n()},this.clearFilter=function(){t.currentFilter(null)},this.mapClick=function(){return t.pinnedPanel()||t.visiblePanel(!1),!0},this.setCurrentPlace=function(n){if(t.currentPlace()&&(t.currentPlace().marker.setAnimation(null),t.currentPlace().marker.setIcon(null)),t.currentPlace(n),n){n.yelpData()||o(n);var i={url:"img/black_marker.png",scaledSize:new google.maps.Size(22,40),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(11,40)};n.marker.setIcon(i),n.marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.marker.setAnimation(null)},2100),a(n,l),r.panTo(n.location),t.visiblePanel(!1)}else e()},this.currentFilter.subscribe(function(){var a=t.currentFilter()||"";t.places().forEach(function(e){e().visible=e().name.toLowerCase().includes(a.toLowerCase()),e(e())}),l.close(),l.marker=null,t.setCurrentPlace(null),e()})},u=new c;ko.applyBindings(u),errorLoadingMapsAPI=function(){alert("Couldn't load Google Maps. Check your connection and try reloading the page.")},initMap=function(){r=new google.maps.Map(document.getElementById("map"),{center:{lat:41.393996,lng:2.176231},zoom:12,mapTypeControl:!1,streetViewControl:!1}),l=new google.maps.InfoWindow;var a;u.places().forEach(function(e){a=new google.maps.Marker({map:r,position:e().location,title:e().name,animation:google.maps.Animation.DROP}),e().marker=a,a.addListener("click",function(){u.setCurrentPlace(e())})}),e()}}();